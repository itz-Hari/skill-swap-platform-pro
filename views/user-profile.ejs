<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Skill Swap</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <%- include('partials/navbar') %>
  
  <div class="container mt-4">
    <% if (messages.success && messages.success.length > 0) { %>
      <div class="alert alert-success alert-dismissible fade show">
        <%= messages.success %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>
    
    <% if (messages.error && messages.error.length > 0) { %>
      <div class="alert alert-danger alert-dismissible fade show">
        <%= messages.error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>
    
    <div class="row">
      <div class="col-lg-4 mb-4">
        <div class="card">
          <div class="card-body text-center">
            <div class="profile-avatar mb-3">
              <div class="avatar-circle">
                <%= viewedUser.name.charAt(0).toUpperCase() %>
              </div>
            </div>
            <h4><%= viewedUser.name %></h4>
            <% if (viewedUser.is_online) { %>
              <span class="badge bg-success mb-2">● Online</span>
            <% } else { %>
              <span class="badge bg-secondary mb-2">○ Offline</span>
            <% } %>
            <p class="text-muted"><%= viewedUser.email %></p>
            <p class="text-muted"><small>Member since <%= new Date(viewedUser.created_at).toLocaleDateString() %></small></p>
            
            <% if (viewedUser.average_rating > 0) { %>
              <div class="rating-stars mb-2">
                <% for(let i = 1; i <= 5; i++) { %>
                  <%= i <= Math.round(viewedUser.average_rating) ? '★' : '☆' %>
                <% } %>
              </div>
              <p class="mb-0"><small><%= viewedUser.average_rating.toFixed(2) %> (<%= viewedUser.rating_count %> <%= viewedUser.rating_count === 1 ? 'rating' : 'ratings' %>)</small></p>
            <% } else { %>
              <p class="text-muted mb-0"><small>No ratings yet</small></p>
            <% } %>
          </div>
        </div>
        
        <% if (!isBlocked) { %>
          <div class="card mt-3">
            <div class="card-body">
              <button class="btn btn-danger btn-sm w-100" onclick="blockUser(<%= viewedUser.id %>)">
                Block User
              </button>
            </div>
          </div>
        <% } else { %>
          <div class="alert alert-warning mt-3">
            <small>This user is blocked</small>
          </div>
        <% } %>
      </div>
      
      <div class="col-lg-8">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Profile Information</h5>
          </div>
          <div class="card-body">
            <% if (viewedUser.bio) { %>
              <div class="mb-4">
                <h6>About</h6>
                <p><%= viewedUser.bio %></p>
              </div>
            <% } %>
            
            <div class="mb-4">
              <h6>Can Teach</h6>
              <p class="text-success"><%= viewedUser.skills_teach || 'Not specified' %></p>
            </div>
            
            <div>
              <h6>Wants to Learn</h6>
              <p class="text-primary"><%= viewedUser.skills_learn || 'Not specified' %></p>
            </div>
          </div>
        </div>
        
        <% if (canRate && !hasRated) { %>
          <div class="card mb-4">
            <div class="card-header bg-warning">
              <h5 class="mb-0">Rate This User</h5>
            </div>
            <div class="card-body">
              <form action="/rate/<%= viewedUser.id %>" method="POST">
                <input type="hidden" name="swapId" value="<%= swapId %>">
                
                <div class="mb-3">
                  <label class="form-label">Rating</label>
                  <div class="rating-input">
                    <input type="radio" name="rating" value="5" id="star5" required>
                    <label for="star5">★</label>
                    <input type="radio" name="rating" value="4" id="star4">
                    <label for="star4">★</label>
                    <input type="radio" name="rating" value="3" id="star3">
                    <label for="star3">★</label>
                    <input type="radio" name="rating" value="2" id="star2">
                    <label for="star2">★</label>
                    <input type="radio" name="rating" value="1" id="star1">
                    <label for="star1">★</label>
                  </div>
                </div>
                
                <div class="mb-3">
                  <label for="review" class="form-label">Review (Optional)</label>
                  <textarea class="form-control" id="review" name="review" rows="3" maxlength="500"></textarea>
                </div>
                
                <button type="submit" class="btn btn-warning">Submit Rating</button>
              </form>
            </div>
          </div>
        <% } else if (hasRated) { %>
          <div class="alert alert-info">
            You have already rated this user
          </div>
        <% } %>
        
        <% if (ratings && ratings.length > 0) { %>
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Ratings & Reviews</h5>
            </div>
            <div class="card-body">
              <% ratings.forEach(rating => { %>
                <div class="border-bottom pb-3 mb-3">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <strong><%= rating.rater_name %></strong>
                      <div class="rating-stars">
                        <% for(let i = 1; i <= 5; i++) { %>
                          <%= i <= rating.rating ? '★' : '☆' %>
                        <% } %>
                      </div>
                    </div>
                    <small class="text-muted"><%= new Date(rating.created_at).toLocaleDateString() %></small>
                  </div>
                  <% if (rating.review_text) { %>
                    <p class="mt-2 mb-0"><%= rating.review_text %></p>
                  <% } %>
                </div>
              <% }) %>
            </div>
          </div>
        <% } %>
        
        <% if (!existingRequest && !isBlocked) { %>
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Send Skill Swap Request</h5>
            </div>
            <div class="card-body">
              <form action="/request/send/<%= viewedUser.id %>" method="POST">
                <div class="mb-3">
                  <label for="skill_offer" class="form-label">Skill I Can Offer</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="skill_offer" 
                    name="skill_offer"
                    placeholder="What skill can you teach them?"
                    maxlength="200"
                    required
                  >
                </div>
                
                <div class="mb-3">
                  <label for="skill_need" class="form-label">Skill I Need</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="skill_need" 
                    name="skill_need"
                    placeholder="What skill do you want to learn?"
                    maxlength="200"
                    required
                  >
                </div>
                
                <div class="mb-3">
                  <label for="message" class="form-label">Message</label>
                  <textarea 
                    class="form-control" 
                    id="message" 
                    name="message" 
                    rows="4"
                    placeholder="Introduce yourself and explain why you'd like to swap skills..."
                    maxlength="500"
                    required
                  ></textarea>
                  <small class="form-text text-muted">Maximum 500 characters</small>
                </div>
                
                <button type="submit" class="btn btn-primary">Send Request</button>
                <a href="/search" class="btn btn-secondary">Back to Search</a>
              </form>
            </div>
          </div>
        <% } else if (existingRequest) { %>
          <div class="alert alert-info">
            <h5>Request Status: <span class="badge bg-<%= existingRequest.status === 'pending' ? 'warning' : existingRequest.status === 'accepted' ? 'success' : 'secondary' %>"><%= existingRequest.status %></span></h5>
            <p class="mb-0">You already have a <%= existingRequest.status %> request with this user.</p>
            <% if (existingRequest.status === 'accepted') { %>
              <a href="/chat/<%= existingRequest.id %>" class="btn btn-primary btn-sm mt-2">Go to Chat</a>
            <% } %>
          </div>
          <a href="/search" class="btn btn-secondary">Back to Search</a>
        <% } %>
      </div>
    </div>
  </div>
  
  <%- include('partials/footer') %>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/main.js"></script>
</body>
</html>
